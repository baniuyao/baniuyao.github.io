<!doctype html>
<html class="theme-next use-motion">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>




  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.3.0rc4"/>






    <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.3.0rc4" />



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?14c861085b24e8d70ed28c14d40e7cbc";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  <title> Baniu Blog </title>
</head>

<body>
  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
    <a href="/" class="brand">
        <span class="logo">
          <i class="icon-logo"></i>
        </span>
        <span class="site-title">Baniu Blog</span>
    </a>
</h1>


  <ul id="menu" class="menu">
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br />
          Home
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          Archives
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          Tags
        </a>
      </li>
    
      
      <li class="menu-item menu-item-about">
        <a href="/about">
          <i class="menu-item-icon icon-about"></i> <br />
          About
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
            
          

          <div id="posts" class="posts-expand">
            
  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/08/27/advanced-python-data-structure/">
                Advanced Python Data Structure
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posted on 2015-08-27
            
          </span>
        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/08/27/advanced-python-data-structure/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/08/27/advanced-python-data-structure/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <h1 id="Intro">Intro</h1>
<p>One of the reason of the vast popularity of <code>Python</code> is that <code>Python</code> has so many useful and handful <code>batteries</code> - <code>dict</code>, <code>list</code>, <code>tuple</code> and so on. But there are also many powerful tools Python originally provides which are not so familiar to us. In this post, I will introduce three modules - <code>Counter</code>, <code>defaultdict</code> and <code>bisect</code> which will be a great help for the daily work.</p>
<h1 id="collections-Couter()">collections.Couter()</h1>
<p><code>Counter</code> is used to count something of iterable data structure such as list and tuple. Let’s see example below:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</div><div class="line">name_list = [<span class="string">'frank'</span>, <span class="string">'frank'</span>, <span class="string">'tony'</span>, <span class="string">'jack'</span>, <span class="string">'judy'</span>, <span class="string">'jack'</span>, <span class="string">'jack'</span>]</div><div class="line">name_counter = Counter(name_list) </div><div class="line"><span class="keyword">print</span> counter <span class="comment"># print couter of name_list</span></div><div class="line"><span class="comment"># Counter({'jack': 3, 'frank': 2, 'tony': 1, 'judy': 1})</span></div><div class="line"><span class="keyword">print</span> counter.most_common(<span class="number">1</span>) <span class="comment"># print top 1 count</span></div><div class="line"><span class="comment"># [('jack', 3)]</span></div><div class="line"><span class="keyword">print</span> counter.most_common(<span class="number">2</span>) <span class="comment"># print top 2 count</span></div><div class="line"><span class="comment"># [('jack', 3), ('frank', 2)]</span></div></pre></td></tr></table></figure>

<p>Now I am going to update a Counter:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</div><div class="line">name_list_one = [<span class="string">'frank'</span>, <span class="string">'frank'</span>, <span class="string">'tony'</span>]</div><div class="line">name_counter = Counter(name_list_one)</div><div class="line"><span class="comment"># name_counter: Counter({'frank': 2, 'tony': 1})</span></div><div class="line">name_list_two = [<span class="string">'tony'</span>, <span class="string">'jack'</span>]</div><div class="line">name_counter.update(name_list_two)</div><div class="line"><span class="comment"># name_counter: Counter({'tony': 2, 'frank': 2, 'jack': 1})</span></div><div class="line">name_counter.subtract([<span class="string">'frank'</span>]) <span class="comment"># subtract is the reverse operation of update</span></div><div class="line"><span class="comment"># name_counter: Counter({'tony': 2, 'frank': 1, 'jack': 1})</span></div><div class="line">name_counter.subtract([<span class="string">'jack'</span>, <span class="string">'jack'</span>]) <span class="comment"># value can be zero and negative counts</span></div><div class="line"><span class="comment"># name_counter: Counter({'tony': 2, 'frank': 1, 'jack': -1})</span></div></pre></td></tr></table></figure>

<h1 id="collections-defaultdict()">collections.defaultdict()</h1>
<p><code>defaultdict</code> is almost the same as <code>dict</code> which can be assigned by this statement:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">d = {<span class="string">'name'</span>: <span class="string">'frank'</span>}</div></pre></td></tr></table></figure>

<p><code>defaultdict</code> provides a function which will be invoked when we use a non-exists key to access the value in the <code>defaultdict</code>. When we want to get the value by a key which does not exist in the dict, <code>dict</code> will raise a <code>KeyError</code> Exception. We can use <code>d.get(KEY, DEFAULT_VALUE)</code> to define the value we will get if the key does not exist. It is okay but not an easy work-around. For example, I have a dict named <code>writer_book_dict</code> and its key is writers’ name and value is books’ name. When I get the value by a non-exist writer, it should return ‘NO BOOKS’. Let’s see how we can deal it with <code>dict</code> and <code>defaultdict</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">writer_book_dict = {<span class="string">'frank'</span>: <span class="string">'book_1'</span>, <span class="string">'tony'</span>: <span class="string">'book_2'</span>}</div><div class="line">book_by_jack = writer_book_dict.get(<span class="string">'jack'</span>, <span class="string">'NO BOOKS'</span>)</div><div class="line">book_by_jack = writer_book_dict.get(<span class="string">'judy'</span>, <span class="string">'NO BOOKS'</span>)</div><div class="line"></div><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</div><div class="line">writer_book_defaultdict = default(lamda: <span class="string">'NO BOOKS'</span>)</div><div class="line">writer_book_defaultdict.get(<span class="string">'jack'</span>) <span class="comment"># return 'NO BOOKS'</span></div></pre></td></tr></table></figure>

<p>We can use a complex function in initialize the defaultdict. Furthermore, we can also define the data structure of the value in the <code>defaultdict</code>. Let’s see an example, we need to make a classification of a short paragraph by the first letter of each world. It is to say, ‘I am a student and I like sports’ -&gt; <code>{&#39;a&#39;: [&#39;am&#39;, &#39;a&#39;, &#39;and&#39;], &#39;i&#39;: [&#39;it&#39;, &#39;is&#39;, &#39;i&#39;], &#39;l&#39;: [&#39;like&#39;], &#39;s&#39;: [&#39;student&#39;, &#39;sports&#39;]}</code>. If we use <code>default</code> we must judge if the key exists and if it does not exist, we need to initialize with an empty list like below:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">paragraph = <span class="string">'I am a student and I like sports'</span></div><div class="line">word_dict = {}</div><div class="line"><span class="keyword">for</span> word <span class="keyword">in</span> paragraph:</div><div class="line">    first_letter = word[<span class="number">0</span>]</div><div class="line">    <span class="keyword">if</span> word <span class="keyword">not</span> <span class="keyword">in</span> word_dict:</div><div class="line">        word_dict[first_letter] = [word]</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        word_dict[first_letter].append(word)</div></pre></td></tr></table></figure>

<p>Let’s see how <code>defaultdict</code> works:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</div><div class="line">paragraph = <span class="string">'I am a student and I like sports'</span></div><div class="line">word_defaultdict = defaultdict(list)</div><div class="line"><span class="keyword">for</span> word <span class="keyword">in</span> paragraph:</div><div class="line">    word_defaultdict[word[<span class="number">0</span>]].append(word)</div></pre></td></tr></table></figure>

<p>If we want to <code>uniq</code> the element of <code>word_defaultdict</code>, we can simply initialize <code>word_defaultdict</code> by <code>defaultdict(set)</code>.</p>
<h1 id="bisect">bisect</h1>
<p><code>bisect</code> is used to insert element into an sorted list and keep the list sorted. <code>bisect</code> module have six methods:</p>
<ol>
<li><code>bisect</code></li>
<li><code>bisect_left</code></li>
<li><code>bisect_right</code></li>
<li><code>insort</code></li>
<li><code>insort_left</code></li>
<li><code>insort_right</code></li>
</ol>
<p>Methods start with <code>bisect</code> will return the index of the element you need to insert. Those start with <code>insort</code> will make change into list directly and return nothing. The difference between <code>left</code> and <code>right</code> will affect the result of operation only when the element you want to insert does exist in the list and <code>left</code> will return the index left of this existed-element and <code>right</code> return the right position. Please remark that <code>bisect</code> is the same as <code>bisect_right</code> and <code>insort</code> is the same as <code>insort_right</code>. Let’s see some examples.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sorted_list = [<span class="number">1</span>, <span class="number">10</span>, <span class="number">100</span>, <span class="number">1000</span>]</div><div class="line">bisect(sorted_list, <span class="number">20</span>) <span class="comment"># return 2</span></div><div class="line">bisect(sorted_list, <span class="number">10</span>) <span class="comment"># return 2</span></div><div class="line">bisect_left(sorted_list, <span class="number">10</span>) <span class="comment"># return 1</span></div><div class="line">bisect_right(sorted_list, <span class="number">10</span>) <span class="comment"># return 1</span></div></pre></td></tr></table></figure>


        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/python/">
                #python
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/06/03/Enable-CORS-in-bottle-py/">
                Enable CORS in bottle.py
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posted on 2015-06-03
            
          </span>
        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/06/03/Enable-CORS-in-bottle-py/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/06/03/Enable-CORS-in-bottle-py/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <h1 id="Solution">Solution</h1>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> Bottle, request, response, run</div><div class="line">app = Bottle()</div><div class="line"> </div><div class="line"><span class="decorator">@app.hook('after_request')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">enable_cors</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    You need to add some headers to each request.</div><div class="line">    Don't use the wildcard '*' for Access-Control-Allow-Origin in production.</div><div class="line">    """</div><div class="line">    response.headers[<span class="string">'Access-Control-Allow-Origin'</span>] = <span class="string">'*'</span></div><div class="line">    response.headers[<span class="string">'Access-Control-Allow-Methods'</span>] = <span class="string">'PUT, GET, POST, DELETE, OPTIONS'</span></div><div class="line">    response.headers[<span class="string">'Access-Control-Allow-Headers'</span>] = <span class="string">'Origin, Accept, Content-Type, X-Requested-With, X-CSRF-Token'</span></div></pre></td></tr></table></figure>


        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/python/">
                #python
              </a>
            
              <a href="/tags/bottle-py/">
                #bottle.py
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/03/27/Kafka-Compression-Performance-Test/">
                Kafka Compression Performance Test
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posted on 2015-03-27
            
          </span>
        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/03/27/Kafka-Compression-Performance-Test/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/03/27/Kafka-Compression-Performance-Test/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <h1 id="Kafka_Compression_Performance_Tests">Kafka Compression Performance Tests</h1>
<h2 id="Backgroud">Backgroud</h2>
<p><code>Kafka</code> use <code>End-to-End</code> compression model which means that <code>Producer</code> and <code>Consumer</code> are doing the compression and de-compression jobs. This feature enables the reduction of on-the-fly network costs and the <code>Broker</code> will increase its cpu load.</p>
<h2 id="Environment">Environment</h2>
<h3 id="Hardware_Box">Hardware Box</h3>
<table>
<thead>
<tr>
<th style="text-align:right">CPU</th>
<th style="text-align:right">Memory</th>
<th style="text-align:right">Disk</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">2.5 GHz Intel Core i7</td>
<td style="text-align:right">16GB</td>
<td style="text-align:right">512GB SSD</td>
</tr>
</tbody>
</table>
<h3 id="Software_Box">Software Box</h3>
<table>
<thead>
<tr>
<th style="text-align:right">Kafka</th>
<th style="text-align:right">JDK</th>
<th style="text-align:right">Scala</th>
<th style="text-align:right">Broker</th>
<th style="text-align:right">Producer</th>
<th style="text-align:right">JVM</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">0.8.2.1</td>
<td style="text-align:right">1.7.0u75</td>
<td style="text-align:right">2.11</td>
<td style="text-align:right">1</td>
<td style="text-align:right">1</td>
<td style="text-align:right">-Xms4G -Xmx4G -Xmn2G</td>
</tr>
</tbody>
</table>
<h3 id="Kafka_Configuration">Kafka Configuration</h3>
<table>
<thead>
<tr>
<th style="text-align:right">Replica</th>
<th style="text-align:right">Partition</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">1</td>
<td style="text-align:right">1</td>
</tr>
</tbody>
</table>
<h3 id="Messages_Content">Messages Content</h3>
<p>The content I used to send to <code>Kafka</code> is a nginx log which contains 607,781 lines and 200MB. Each line is like below:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">127.0</span>.<span class="number">0.1</span> - - [<span class="number">24</span><span class="regexp">/Mar/</span><span class="number">2015</span>:<span class="number">15</span>:<span class="number">57</span>:<span class="number">09</span> +<span class="number">0800</span>] <span class="string">"GET /login?gotype=2 HTTP/1.1"</span> <span class="string">"0.002"</span> <span class="number">200</span> <span class="number">3177</span> <span class="string">"http://abc.com/URLhtml"</span> <span class="string">"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; .NET4.0C; .NET4.0E)"</span> <span class="number">127.0</span>.<span class="number">0.1</span> foo.com foo-hostname</div></pre></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$wc</span> -l test.access.<span class="keyword">log</span></div><div class="line">  <span class="number">607781</span> test.access.<span class="keyword">log</span></div><div class="line">  ~/Downloads</div><div class="line">  <span class="variable">$du</span> -sh test.access.<span class="keyword">log</span></div><div class="line">  <span class="number">200</span>M  test.access.<span class="keyword">log</span></div></pre></td></tr></table></figure>

<h2 id="Baseline_Test">Baseline Test</h2>
<h3 id="Kafka_Producer_Configuration">Kafka Producer Configuration</h3>
<table>
<thead>
<tr>
<th style="text-align:right">compression.type</th>
<th style="text-align:right">buffered.memory</th>
<th style="text-align:right">acks</th>
<th style="text-align:right">linger.ms</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">None</td>
<td style="text-align:right">32MB</td>
<td style="text-align:right">1</td>
<td style="text-align:right">0</td>
</tr>
</tbody>
</table>
<h3 id="Test_Result">Test Result</h3>
<p>  The first test is going to figure out the fact that the value we defined in <code>batch.size</code> is not the exactly batch size <code>Producer</code> will use. I got the real batch size of <code>Producer</code> by using its metrics API. Tests have been done with <code>batch.size</code> of 200, 500, 1000, 1200, 1500, 2000. Chart below is the result: </p>
<p>  <img src="/images/kafka_tests/batch_size.png" alt="batch_size"></p>
<p>  We can see clearly that <code>batch.size</code> is a smaller than <code>batch-size-avg</code>(it is the excatly batch size <code>Producer</code> used). And while the <code>batch.size</code> is 200 and 500, the <code>batch-size-avg</code> is almost the same - aroud 370. That is to say, <code>batch-size-avg</code> is not only settled by the parameter <code>batch.size</code>, furthermore, it is also related to other factor.</p>
<p>  All tests have been done in different <code>batch.size</code> of 500, 1000, 1200, 1500 and 2000. Why I didn’t use <code>batch.size</code> of 200 because the phenomenon in the above paragraph.</p>
<p>  Let’s take a look on the <code>Producer</code> baseline：</p>
<p>  <img src="/images/kafka_tests/producer_baseline.png" alt="producer_baseline"></p>
<p>  The throughput rised along with the increasing of <code>batch.size</code>. And the latency rised as well. Let me make a simple math calculation. I use the <code>batch.size</code> of 500 for the base number and get the percentage of throughput and latency increasement.</p>
<table>
<thead>
<tr>
<th style="text-align:right">-</th>
<th style="text-align:right">500</th>
<th style="text-align:right">1000</th>
<th style="text-align:right">1200</th>
<th style="text-align:right">1500</th>
<th style="text-align:right">2000</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">throughtput</td>
<td style="text-align:right">100%</td>
<td style="text-align:right">183.25%</td>
<td style="text-align:right">230.74%</td>
<td style="text-align:right">289.59%</td>
<td style="text-align:right">387.81%</td>
</tr>
<tr>
<td style="text-align:right">latency</td>
<td style="text-align:right">100%</td>
<td style="text-align:right">117.47%</td>
<td style="text-align:right">121.40%</td>
<td style="text-align:right">123.76%</td>
<td style="text-align:right">128.31%</td>
</tr>
</tbody>
</table>
<p>  <img src="/images/kafka_tests/producer_baseline_ratio.png" alt="producer_baseline_ratio"></p>
<h3 id="Conclusion">Conclusion</h3>
<p>  The throughtput of <code>Producer</code> can get much higher with the increasing of <code>batch.size</code>. And at the meantime, latency will increas in a very tiny level.</p>
<h2 id="Producer_Performance_with_Compression">Producer Performance with Compression</h2>
<p>  <code>Kafka</code> support three different compression type：</p>
<ul>
<li>gzip</li>
<li>snappy</li>
<li>lz4</li>
</ul>
<p>  Because of the box I use to test, when I use <code>lz4</code> in testing, I got OOM exception. I think the casuse of this exception is the Java code will get all lines of the <code>test.access.log</code> and send to <code>Kafka</code> in a very short time. So I used <code>batch.size</code> of 2000, 2500, 3000, 3500, 4000, 4500 and 5000. Using big <code>batch.size</code> will increass the latency and this will give JVM some time to do the GC jobs.</p>
<p>  Below is the result</p>
<h3 id="Compression_Rate">Compression Rate</h3>
<p>  The value is better when it is smaller.</p>
<table>
<thead>
<tr>
<th style="text-align:center">-</th>
<th style="text-align:center">none</th>
<th style="text-align:center">gzip</th>
<th style="text-align:center">snappy</th>
<th style="text-align:center">lz4</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">AverageCompressionRate</td>
<td style="text-align:center">100%</td>
<td style="text-align:center">19.21%</td>
<td style="text-align:center">78.19%</td>
<td style="text-align:center">31.37%</td>
</tr>
</tbody>
</table>
<p>  <img src="/images/kafka_tests/compression_rate.png" alt="compression_rate"></p>
<h3 id="Throughput">Throughput</h3>
<p>  When I enabled the compression, the througput decreased. Let’s see the result.</p>
<table>
<thead>
<tr>
<th style="text-align:right">-</th>
<th style="text-align:right">none</th>
<th style="text-align:right">gzip</th>
<th style="text-align:right">snappy</th>
<th style="text-align:right">lz4</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">Average Throughput</td>
<td style="text-align:right">151901.1038</td>
<td style="text-align:right">39346.00017</td>
<td style="text-align:right">119707.5266</td>
<td style="text-align:right">191469.8994</td>
</tr>
</tbody>
</table>
<p>  <img src="/images/kafka_tests/compression_throughput.png" alt="compression_throughput"></p>
<h3 id="Latency">Latency</h3>
<p>  Result:</p>
<table>
<thead>
<tr>
<th style="text-align:right">-</th>
<th style="text-align:right">none</th>
<th style="text-align:right">gzip</th>
<th style="text-align:right">snappy</th>
<th style="text-align:right">lz4</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">Average Latency ms</td>
<td style="text-align:right">0.25</td>
<td style="text-align:right">4.97</td>
<td style="text-align:right">0.41</td>
<td style="text-align:right">0.66</td>
</tr>
<tr>
<td style="text-align:right">Ration</td>
<td style="text-align:right">100.00%</td>
<td style="text-align:right">1937.61%</td>
<td style="text-align:right">159.99%</td>
<td style="text-align:right">258.62%</td>
</tr>
</tbody>
</table>
<p>  <img src="/images/kafka_tests/compression_latency.png" alt="compression_latency"></p>
<h1 id="Consumer_Performance_with_Compression">Consumer Performance with Compression</h1>
<p>  Because <code>Kafka</code> 0.8.2.1 has not enabled the new <code>Consumer</code>, so I cannot get the detailed metrics like I have got in <code>Producer</code>. So in this test, I use the total time <code>Consumer</code> used to consumes a fixed number of messages to do the benchmark.</p>
<p>  The messages are <code>test.access.log</code> in twice size. Below is the result</p>
<table>
<thead>
<tr>
<th style="text-align:center">-</th>
<th style="text-align:left">none</th>
<th style="text-align:right">gzip</th>
<th style="text-align:center">snappy</th>
<th style="text-align:right">lz4</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Time Cost ms</td>
<td style="text-align:left">3218</td>
<td style="text-align:right">5374</td>
<td style="text-align:center">5216</td>
<td style="text-align:right">4507</td>
</tr>
<tr>
<td style="text-align:center">Time Cost Increase Rate</td>
<td style="text-align:left">100%</td>
<td style="text-align:right">167%</td>
<td style="text-align:center">162.09%</td>
<td style="text-align:right">140.06%</td>
</tr>
</tbody>
</table>
<p>  <img src="/images/kafka_tests/cosumer_time_cost.png" alt="consumer_time_cose"></p>
<p>  We can see <code>lz4</code> is the fastest.</p>
<h1 id="Conclusion-1">Conclusion</h1>
<p>  <code>lz4</code> is the best choice in compression rate and both performance of <code>Producer</code> and <code>Consumer</code>. Below is the comparison of <code>lz4</code> performance and base line performance. For simplified the chart, this only shows the result with <code>batch.size</code> of 5000.</p>
<p>  <img src="/images/kafka_tests/overview.png" alt="overview"></p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Kafka/">
                #Kafka
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/03/04/The-analysis-of-Zabbix-history-trends-storing/">
                The analysis of Zabbix history/trends storing
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posted on 2015-03-04
            
          </span>
        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/03/04/The-analysis-of-Zabbix-history-trends-storing/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/03/04/The-analysis-of-Zabbix-history-trends-storing/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <h2 id="Intro">Intro</h2>
<p><code>history</code> and <code>trends</code> are two main tables in Zabbix database for storing data. There are also tables inherits <code>history</code> which are used to store different types of data. For example, table <code>history_unit</code> is to store <code>uint</code> data. Others are <code>history_str</code>, <code>history_log</code> and <code>history_text</code>. Please pay attention that there is only one table inherits table <code>trends</code> and its name is <code>table_uint</code>.</p>
<h2 id="Entrance">Entrance</h2>
<p>The start of the whole process is in function <code>DCsync_all()</code>, <code>src/libs/zbxdbcache/dbcache.c</code>. <code>dbcache</code> is a feature which enables Zabbix to keep data in memory first and flush to database in batch.</p>
<p>To make it more clearly, I wrote comments inline.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">void</span>	DCsync_all()</div><div class="line">{</div><div class="line">	zabbix_log(LOG_LEVEL_DEBUG, <span class="string">"In DCsync_all()"</span>);</div><div class="line">	</div><div class="line">	<span class="comment">// call `DCsync_history` to sync history data from cache to database</span></div><div class="line">	DCsync_history(ZBX_SYNC_FULL);</div><div class="line">	<span class="comment">// assert code is running in Zabbix Server. Zabbix Server WILL NOT run codes below</span></div><div class="line">	<span class="keyword">if</span> (<span class="number">0</span> != (daemon_type & ZBX_DAEMON_TYPE_SERVER))</div><div class="line">		<span class="comment">// sync trends data. </span></div><div class="line">		DCsync_trends();</div><div class="line"></div><div class="line">	zabbix_log(LOG_LEVEL_DEBUG, <span class="string">"End of DCsync_all()"</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="DCsync_history()">DCsync_history()</h2>
<p>Since we are talking about Zabbix Server, so we will only take a look at <code>DCsync_history()</code>. In this paragraph, I have simplified the code in <code>DCsync_history()</code> to help readers understand the core process of flushing data to database.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">DBbegin();</div><div class="line">	</div><div class="line"><span class="comment">// while in Zabbix Server mode</span></div><div class="line"><span class="keyword">if</span> (<span class="number">0</span> != (daemon_type & ZBX_DAEMON_TYPE_SERVER))</div><div class="line">{</div><div class="line">	...</div><div class="line">	<span class="comment">// add data to history</span></div><div class="line">	DCmass_add_history(history, history_num);</div><div class="line">	<span class="comment">// update trends</span></div><div class="line">	DCmass_update_trends(history, history_num);</div><div class="line">	...		</div><div class="line">}</div><div class="line"><span class="keyword">else</span></div><div class="line">{</div><div class="line">	DCmass_proxy_add_history(history, history_num);</div><div class="line">	...</div><div class="line">}</div><div class="line"></div><div class="line">DBcommit();</div></pre></td></tr></table></figure>

<h3 id="DCmass_add_history()">DCmass_add_history()</h3>
<p>Let’s take a look into <code>DCmass_add_history()</code>.</p>
<p>It will calculate the numbers for each type of items.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span> (history[i].value_type)</div><div class="line">	{</div><div class="line">		<span class="keyword">case</span> ITEM_VALUE_TYPE_FLOAT:</div><div class="line">			h_num++;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> ITEM_VALUE_TYPE_UINT64:</div><div class="line">			huint_num++;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> ITEM_VALUE_TYPE_STR:</div><div class="line">			hstr_num++;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> ITEM_VALUE_TYPE_TEXT:</div><div class="line">			htext_num++;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> ITEM_VALUE_TYPE_LOG:</div><div class="line">			hlog_num++;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>And then, call function to write data to database.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* history */</span></div><div class="line"><span class="keyword">if</span> (<span class="number">0</span> != h_num)</div><div class="line">	dc_add_history_dbl(history, history_num);</div><div class="line"></div><div class="line"><span class="comment">/* history_uint */</span></div><div class="line"><span class="keyword">if</span> (<span class="number">0</span> != huint_num)</div><div class="line">	dc_add_history_uint(history, history_num);</div></pre></td></tr></table></figure>

<p>Finally, we can touch the sql in <code>dc_add_history_dbl()</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">void</span>	dc_add_history_dbl(ZBX_DC_HISTORY *history, <span class="keyword">int</span> history_num)</div><div class="line">{</div><div class="line">	...</div><div class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; history_num; i++)</div><div class="line">	{</div><div class="line">		...</div><div class="line">		zbx_db_insert_add_values(&db_insert, history[i].itemid, history[i].ts.sec, history[i].ts.ns,</div><div class="line">				history[i].value.dbl);</div><div class="line">	}</div><div class="line">	...</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="DCmass_update_trends">DCmass_update_trends</h3>
<p>Let’s see the code first.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">void</span>	DCmass_update_trends(ZBX_DC_HISTORY *history, <span class="keyword">int</span> history_num)</div><div class="line">{</div><div class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; history_num; i++)</div><div class="line">	{</div><div class="line">		...</div><div class="line">		DCadd_trend(&history[i], &trends, &trends_alloc, &trends_num);</div><div class="line">	}</div><div class="line">	...</div><div class="line">	<span class="keyword">while</span> (<span class="number">0</span> &lt; trends_num)</div><div class="line">		<span class="comment">// flush trends while we actually HAVE trends data to flush</span></div><div class="line">		DCflush_trends(trends, &trends_num, <span class="number">1</span>);</div><div class="line">	...</div><div class="line">}</div></pre></td></tr></table></figure>

<p>We get that the main process is in the function <code>DCadd_trend()</code>. Let’s move on to it.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">void</span>	DCadd_trend(ZBX_DC_HISTORY *history, ZBX_DC_TREND **trends, <span class="keyword">int</span> *trends_alloc, <span class="keyword">int</span> *trends_num)</div><div class="line">{</div><div class="line">	...</div><div class="line">	<span class="comment">// get trend data from database by itemid</span></div><div class="line">	trend = DCget_trend(history-&gt;itemid);</div><div class="line">	...</div><div class="line">	<span class="keyword">switch</span> (trend-&gt;value_type)</div><div class="line">	{</div><div class="line">		<span class="keyword">case</span> ITEM_VALUE_TYPE_FLOAT:</div><div class="line">			...</div><div class="line">			<span class="comment">// calculate the new data</span></div><div class="line">			trend-&gt;value_avg.dbl = (trend-&gt;num * trend-&gt;value_avg.dbl</div><div class="line">				+ history-&gt;value.dbl) / (trend-&gt;num + <span class="number">1</span>);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		...</div><div class="line">}</div></pre></td></tr></table></figure>

<p>Above all, I think we are clear on the fact how Zabbix update history and trends. </p>
<p>Below is the process:<br><img src="/images/zabbix_history_trends.jpg" alt="Zabbix Flow for history and trends"></p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/zabbix/">
                #zabbix
              </a>
            
              <a href="/tags/c/">
                #c
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/02/27/Zabbix-install-issue-with-aclocal-1-14-is-missing/">
                Zabbix install issue with aclocal-1.14 is missing
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posted on 2015-02-27
            
          </span>
        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/02/27/Zabbix-install-issue-with-aclocal-1-14-is-missing/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/02/27/Zabbix-install-issue-with-aclocal-1-14-is-missing/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <h2 id="Backgroud">Backgroud</h2>
<p><code>configure</code> is okay, the next step is <code>make install</code>. But <code>make install</code> exist with error which said it cannot find <code>aclocal-1.14</code> like below:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[baniuyao@YaoRenjies-CentOS zabbix-<span class="number">2.4</span>.<span class="number">4</span>]$ <span class="built_in">sudo</span> make install</div><div class="line">CDPATH=<span class="string">"<span class="variable">${ZSH_VERSION+.}</span>:"</span> && <span class="built_in">cd</span> . && /bin/sh /home/baniuyao/apps/zabbix-<span class="number">2.4</span>.<span class="number">4</span>/missing aclocal-<span class="number">1.14</span> -I m4</div><div class="line">/home/baniuyao/apps/zabbix-<span class="number">2.4</span>.<span class="number">4</span>/missing: line <span class="number">81</span>: aclocal-<span class="number">1.14</span>: command not found</div><div class="line">WARNING: <span class="string">'aclocal-1.14'</span> is missing on your system.</div><div class="line">         You should only need it <span class="keyword">if</span> you modified <span class="string">'acinclude.m4'</span> or</div><div class="line">         <span class="string">'configure.ac'</span> or m4 files included by <span class="string">'configure.ac'</span>.</div><div class="line">         The <span class="string">'aclocal'</span> program is part of the GNU Automake package:</div><div class="line">         &lt;http://www.gnu.org/software/automake&gt;</div><div class="line">         It also requires GNU Autoconf, GNU m4 and Perl <span class="keyword">in</span> order to run:</div><div class="line">         &lt;http://www.gnu.org/software/autoconf&gt;</div><div class="line">         &lt;http://www.gnu.org/software/m4/&gt;</div><div class="line">         &lt;http://www.perl.org/&gt;</div><div class="line">make: *** [aclocal.m4] Error <span class="number">127</span></div></pre></td></tr></table></figure>

<p>But the system has <code>aclocal-1.14</code> already:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[baniuyao@YaoRenjies-CentOS ~]$ which aclocal-<span class="number">1.14</span></div><div class="line">/usr/local/bin/aclocal-<span class="number">1.14</span></div></pre></td></tr></table></figure>

<h2 id="Solution">Solution</h2>
<p>This is because we don’t have some autoconf(*.ac) and automake(*.am) files. We can <code>touch</code> these.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">touch configure.ac aclocal.m4 configure Makefile.am Makefile.in</div></pre></td></tr></table></figure>

<p>Or we can use <code>autoreconf</code> to generate.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">sudo</span> autoreconf -ivf</div></pre></td></tr></table></figure>

<p>Let’s figure out what <code>ivf</code> means.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-v, --verbose            verbosely report processing</div><div class="line"><span class="operator">-f</span>, --force              consider all files obsolete</div><div class="line">-i, --install            copy missing auxiliary files</div></pre></td></tr></table></figure>


        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/zabbix/">
                #zabbix
              </a>
            
              <a href="/tags/linux/">
                #linux
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/01/13/Install-thrift-with-glibc-on-CentOS/">
                Install Thrift with glibc on CentOS
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posted on 2015-01-13
            
          </span>
        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/01/13/Install-thrift-with-glibc-on-CentOS/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/01/13/Install-thrift-with-glibc-on-CentOS/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <h1 id="Install_glib">Install glib</h1>
<h2 id="Install_the_Developments_Tools">Install the Developments Tools</h2>
<p><code>Development Tools</code> is a group of pacakges in yum such <code>automake</code>, <code>autoconf</code> and so on.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">sudo</span> yum -y update</div><div class="line"><span class="built_in">sudo</span> yum -y groupinstall <span class="string">"Development Tools"</span></div><div class="line"><span class="built_in">sudo</span> yum install -y wget</div></pre></td></tr></table></figure>

<h2 id="Upgrade_some_tools">Upgrade some tools</h2>
<p>Although some tools are included in the <code>Development Tools</code>, <code>glibc</code> and <code>thrift</code> need new version of those tools. We need to upgrade them.</p>
<h3 id="autoconf">autoconf</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">wget http://ftp.gnu.org/gnu/autoconf/autoconf-<span class="number">2.69</span>.tar.gz</div><div class="line">tar xvf autoconf-<span class="number">2.69</span>.tar.gz</div><div class="line"><span class="built_in">cd</span> autoconf-<span class="number">2.69</span></div><div class="line">./configure</div><div class="line">make</div><div class="line"><span class="built_in">sudo</span> make install</div><div class="line"><span class="built_in">cd</span> ..</div></pre></td></tr></table></figure>

<h3 id="automake">automake</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">wget http://ftp.gnu.org/gnu/automake/automake-<span class="number">1.14</span>.tar.gz</div><div class="line">tar xvf automake-<span class="number">1.14</span>.tar.gz</div><div class="line"><span class="built_in">cd</span> automake-<span class="number">1.14</span></div><div class="line">./configure</div><div class="line">make</div><div class="line"><span class="built_in">sudo</span> make install</div><div class="line"><span class="built_in">cd</span> ..</div></pre></td></tr></table></figure>

<h3 id="bison">bison</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">wget http://ftp.gnu.org/gnu/bison/bison-<span class="number">2.5</span>.<span class="number">1</span>.tar.gz</div><div class="line">tar xvf bison-<span class="number">2.5</span>.<span class="number">1</span>.tar.gz</div><div class="line"><span class="built_in">cd</span> bison-<span class="number">2.5</span>.<span class="number">1</span></div><div class="line">./configure</div><div class="line">make</div><div class="line"><span class="built_in">sudo</span> make install</div><div class="line"><span class="built_in">cd</span> ..</div></pre></td></tr></table></figure>

<h2 id="Install_glib-1">Install glib</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">wget http://ftp.gnome.org/pub/gnome/sources/glib/<span class="number">2.42</span>/glib-<span class="number">2.42</span>.<span class="number">0</span>.tar.xz</div><div class="line">tar xvf glib-<span class="number">2.42</span>.<span class="number">0</span>.tar.xz</div><div class="line"><span class="built_in">cd</span> glib-<span class="number">2.42</span>.<span class="number">0</span></div><div class="line">./configure</div><div class="line">make</div><div class="line"><span class="built_in">sudo</span> make install</div><div class="line"><span class="built_in">cd</span> ..</div></pre></td></tr></table></figure>

<h2 id="Check">Check</h2>
<p><code>pkgconfig</code> is in <code>/usr/local/lib/pkgconfig</code> or <code>/usr/lib64/pkgconfig</code>. Please find it by yourself by <code>locate pkgconfig</code>. Further, you must add <code>PKG_CONFIG_PATH</code> in your environment variables.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ls -lrt /usr/local/lib/pkgconfig</div><div class="line"><span class="built_in">echo</span> <span class="string">"export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig"</span> &gt;&gt; /etc/profile</div><div class="line"><span class="built_in">source</span> /etc/profile</div></pre></td></tr></table></figure>

<h1 id="Install_thrift">Install thrift</h1>
<p>If you get <code>thrift</code> from <code>git</code>, you must run <code>bootstrap.sh</code> first.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> thrift-<span class="number">0.9</span>.<span class="number">2</span></div><div class="line">./configure --with-lua=no</div><div class="line">result:</div><div class="line">Building C++ Library ......... : no</div><div class="line">Building C (GLib) Library .... : yes</div><div class="line">Building Java Library ........ : no</div><div class="line">Building C<span class="comment"># Library .......... : no</span></div><div class="line">Building Python Library ...... : yes</div><div class="line">Building Ruby Library ........ : no</div><div class="line">Building Haskell Library ..... : no</div><div class="line">Building Perl Library ........ : no</div><div class="line">Building PHP Library ......... : no</div><div class="line">Building Erlang Library ...... : no</div><div class="line">Building Go Library .......... : no</div><div class="line">Building D Library ........... : no</div><div class="line">Building NodeJS Library ...... : no</div><div class="line">Building Lua Library ......... : yes</div><div class="line"></div><div class="line">make </div><div class="line">make install</div></pre></td></tr></table></figure>


        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/thrift/">
                #thrift
              </a>
            
              <a href="/tags/glib/">
                #glib
              </a>
            
              <a href="/tags/linux/">
                #linux
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  

          </div>

          
        </div>

        
<div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>

<div id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    

    <div class="site-overview">
      <div class="site-author motion-element">
        <img class="site-author-image" src="/images/avatar.JPG" alt="Baniu Yao" />
        <p class="site-author-name">Baniu Yao</p>
      </div>
      <p class="site-description motion-element"></p>
      <div class="site-state motion-element">
        <div class="site-state-item site-state-posts">
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">posts</span>
        </div>
        <div class="site-state-item site-state-tags">
            <span class="site-state-item-count">13</span>
            <span class="site-state-item-name">tags</span>
        </div>
        <div class="site-state-item site-state-pages">
            <span class="site-state-item-count">2</span>
            <span class="site-state-item-name">pages</span>
        </div>
      </div>

      

      <div class="social-info motion-element">
        
          
            <span class="soclial-item">
              <a href="https://github.com/baniuyao">GITHUB</a>
            </span>
          
            <span class="soclial-item">
              <a href="http://webo.com/frankymryao">WEIBO</a>
            </span>
          
        
      </div>

    </div>

    
  </div>
</div>


      </div>
    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp; 
  2015
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">Baniu Yao</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT</a>
</div>





      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $(".fancybox").fancybox();
    });
  </script>

  <script type="text/javascript">
  function isDesktop () {
    return screen.width > 991;
  }

  function isTablet () {
    return screen.width < 992 && screen.width > 767;
  }

  function isMobile () {
    return screen.width < 767;
  }

  function escapeSelector (selector) {
    return selector.replace(/[!"$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&")
  }
</script>

  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  
  <script type="text/javascript" id="motion.page.home">
    $(document).ready(function () {
      $.Velocity.RunSequence([
        { e: $('.brand'), p: { opacity: 1 }, o: { duration: 100 } },
        { e: $('.logo'), p: { opacity: 1, top: 0 }, o: { duration: 50} },
        { e: $('.site-title'), p: { opacity: 1, top: 0 }, o: { duration: 200, sequenceQueue: false } }
      ]);
      $('.menu-item').velocity('transition.slideDownIn', {display: null});
    });
  </script>


  <script type="text/javascript" id="motion.global">
  $(document).ready(function () {
    var body = $('body');
    var isSidebarVisible = false;
    var sidebarToggle = $('.sidebar-toggle');
    var sidebarToggleLine1st = $('.sidebar-toggle-line-first')
    var sidebarToggleLine2nd = $('.sidebar-toggle-line-middle');
    var sidebarToggleLine3rd = $('.sidebar-toggle-line-last');
    var sidebar = $('.sidebar');

    var SIDEBAR_WIDTH = '320px';
    var SIDEBAR_DISPLAY_DURATION = 300;

    var sidebarToogleLineStatusInit = {width: '100%', opacity: 1, left: 0, rotateZ: 0, top: 0};

    var sidebarToggleLine1stStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine1stStatusArrow = {width: '50%', rotateZ: '-45deg', top: '2px'};
    var sidebarToogleLine1stStatusClose = {width: '100%', rotateZ: '-45deg', top: '5px'};

    var sidebarToggleLine2ndStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine2ndStatusArrow = {width: '90%'};
    var sidebarToogleLine2ndStatusClose = {opacity: 0};

    var sidebarToggleLine3rdStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine3rdStatusArrow = {width: '50%', rotateZ: '45deg', top: '-2px'};
    var sidebarToogleLine3rdStatusClose = {width: '100%', rotateZ: '45deg', top: '-5px'};

    sidebatToggleMotion();
    postsListMotion();
    backToTopMotion();


    $(document)
      .on('sidebar.show', function () {
        isDesktop() && body.velocity(
          {paddingRight: SIDEBAR_WIDTH},
          SIDEBAR_DISPLAY_DURATION
        );
        sidebarContentMotion();
      })
      .on('sidebar.hide', function () {

      });


    function backToTopMotion () {
      var b2top = $('.back-to-top');
      b2top.on('click', function () {
        body.velocity('scroll');
      });
    }

    function sidebarShowMotion () {

      sidebarToggleLine1st.velocity(sidebarToogleLine1stStatusClose);
      sidebarToggleLine2nd.velocity(sidebarToogleLine2ndStatusClose);
      sidebarToggleLine3rd.velocity(sidebarToogleLine3rdStatusClose);

      sidebar.velocity({width: SIDEBAR_WIDTH}, SIDEBAR_DISPLAY_DURATION);
      sidebar.trigger('sidebar.show');
    }

    function sidebarHideMotion () {
      isDesktop() && body.velocity({paddingRight: 0});
      sidebar.velocity('reverse');

      sidebarToggleLine1st.velocity(sidebarToggleLine1stStatusInit);
      sidebarToggleLine2nd.velocity(sidebarToggleLine2ndStatusInit);
      sidebarToggleLine3rd.velocity(sidebarToggleLine3rdStatusInit);

      sidebar.trigger('sidebar.hide');
    };

    function sidebarContentMotion () {
      $('.sidebar .motion-element').velocity(
        'transition.slideRightIn',
        {stagger: 50, drag: true}
      );
    }

    function postsListMotion () {
      $('.post').velocity('transition.slideDownIn', {stagger: 300, drag: true});
    }

    function sidebatToggleMotion () {
      sidebarToggle.on('click', function () {
        isSidebarVisible ? sidebarHideMotion() : sidebarShowMotion();
        isSidebarVisible = !isSidebarVisible;
      });

      sidebarToggle.hover(function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusArrow);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusArrow);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusArrow);
      }, function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusInit);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusInit);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusInit);
      });
    }
  });

</script>





  

  

  
  

  

    
      
    

    <script type="text/javascript">
      var disqus_shortname = 'baniuyao';
      var disqus_identifier = '';
      var disqus_url = '';

      (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }());
    </script>
  


  
</body>
</html>
